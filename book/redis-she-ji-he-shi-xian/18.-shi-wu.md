# 18.事务

## 1. 事务的实现：

   一个事务从开始到结束会经历一下三个阶段：  
     事务开始 --&gt; 命令入队 --&gt; 事务执行。

## 2. 事务开始：

   MULTI 命令的执行标志着事务的开始：

```text
redis> MULTI

OK
```

## 3. 命令入队：

   当一个客户端处于非事务的状态时，这个客户端发送的命令会立即被服务器执行。 当一个客户端切换到事务状态之后，服务器会根据这个客户端发来的不同的命令执行不同的操作。下面这张图说明了不同状态执行的过程：  
![avatar](../../.gitbook/assets/shi-wu-de-zhi-hang-guo-cheng.png)

## 4. 事务队列：

  每个 redis 客户端都有自己的事务状态，这个事务状态保存在客户端状态的 mstate 属性里面。事务队列是以先进先出的方式保存入队的命令。

## 5. 执行事务：

   当一个处于事务状态的客户端向服务器发送 exec 命令时，这个 exec 命令将会立即被服务器执行。服务器会遍历这个客户端的事务队列，执行队列中保存所有的命令，最后将执行的命令所得到的的结果全部返回客户端。

## 6. WATCH 命令实现：

   WATCH 命令是一个乐观锁，他可以在 exec 命令执行前，监视任意数量的数据库键，并在执行 exec 命令时，检查被监视的键是否至少有一个被修改过了， 如果是的话，服务器将拒绝执行事务，并向客户端返回代表事务执行失败的空回复。

```java
    WATCH "name"   //  监控  name 键
    ok

    MULTI           // 开启事务
    ok

    set name "lidong"
    ok 

    exec              //执行事务
```

## 7. 事务的 ACID 性质：

   在 redis 中 事务总是具有原子性，一致性和隔离性，并且 redis 运行在某种特定的持久化模式下时，事务也具有耐久性 。

## 8. 原子性 ：

   事务的原子性指的是，将多个操作当成一个整体来执行，服务器执行事务中的所有操作，要么全部成功，要么全部失败。    redis 的事务和传统的关系型数据库最大的区别在于， redis 不支持事务回滚机制，即使中间有错误也会执行到最后。

## 9. 一致性 ：

## 10. 隔离性 ：

   事物的隔离性指的是,即使数据库中有多个事物并发的执行,各个事物之间也不会互相影响,并且在并发状态下执行的事务和穿行执行的事物产生的结果完全相同。  
   因为 redis 使用单线程的方式来执行事物,并且服务器保证,在执行事物期间不会对事物进行中断,并且事物也是总具有隔离性。

## 11. 耐久性 ：

   事物的耐久性指的是，当一个事物执行完毕时，执行这个事物所得的结果已经被保存到永久的存储介质里面。即使服务器在事物执行完成以后停机，执行事物所得的结果也不会丢失 。  
     1。 当服务器在无持久化的内存模式下运作时，事物不具有耐久性： 一旦服务器停机，包括事物数据在内的所有服务器数据将丢失。  
     2. 使用 RDB 模式也不会有耐久性 。  
     3. 使用 AOF 模式,并且 appendfsync 选项的值为 alawsy 时,程序总会执行命令之后的同步函数,将命令数据真正的保存到硬盘中 。 他是具备耐久性的  
     4. 使用 AOF 模式,并且 appendfsync 选项的值为 everysec 时,程序会每一秒同步一次命令到硬盘中,因为停机可能恰好发生在等待同步的那一秒钟,可能造成数据丢失,所有不具备耐久性 。  
     5. 使用 AOF 模式, 并且 appendfsync 选项的值为 no 时,程序会交由操作系统来决定何时将数据同步到硬盘中,因为业务数据可能在等待同步的过程中丢失,所以这种情况也不具备耐久性。

